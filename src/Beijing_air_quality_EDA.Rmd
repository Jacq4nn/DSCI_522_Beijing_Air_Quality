---
title: "Exploratory data analysis of Beijing air quality data set"
output: github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message=FALSE)
library(here)
library(tidyverse)
library(knitr)
library(ggplot2)
library(ggthemes)
library(scales)
library(cowplot)
theme_set(theme_minimal())
set.seed(2020)
```

# Summary of the data set

## Data Import

The data is downloaded and unzipped by [python script](./download_data.py). 12 csv files are used in this project. Each file represents one of 12 nationally-controlled air-quality monitoring sites. They are all in the same format, and are merged and stored in `air_data`.

```{r load data}
csv_list <- dir(here("data", "raw","PRSA_Data_20130301-20170228"))

air_data <- data.frame()
for (file_name in csv_list) {
        air_data <-
                rbind(air_data, 
                      read_csv(here("data", 
                                    "raw", 
                                    "PRSA_Data_20130301-20170228", 
                                    file_name), 
                               show_col_types = FALSE))
}

head(air_data)
```

## Study the data

The data set used in this project is an hourly air pollutants data from 12 nationally-controlled air-quality monitoring sites in Beijing, China from 1 March 2013 to 28 February 2017. The air-quality data is from the Beijing Municipal Environmental Monitoring Center. It was sourced from the UCI Machine Learning Repository [here](https://archive-beta.ics.uci.edu/ml/datasets/beijing+multi+site+air+quality+data).

Below we show the structure of each features in the data set.

```{r study data}
str(air_data, give.attr = FALSE)
```

Each row in the data set represents a measurements of air pollutants (e.g., PM2.5, PM10, CO) at specific date and time in 12 different district in Beijing, including Aotizhongxin, Changping, Dingling and so on. The meteorological data in each air-quality site are matched with the nearest weather station from the China Meteorological Administration. There are `420,768` observations in the data set, and `18` features. Below we show the description and missing value of each features in the data set.

```{r missing value}
missing_values <- data.frame(apply(is.na(air_data), 2, sum))

missing_values <- cbind(
        missing_values,
        c(
                'Row number',
                'Year of data in this row',
                'Month of data in this row',
                'Day of data in this row',
                'Hour of data in this row',
                'PM2.5 concentration (ug/m^3)',
                'PM10 concentration (ug/m^3)',
                'SO2 concentration (ug/m^3)',
                'NO2 concentration (ug/m^3)',
                'CO concentration (ug/m^3)',
                'O3 concentration (ug/m^3)',
                'Temperature (degree Celsius)',
                'Pressure (hPa)',
                'Dew point temperature (degree Celsius)',
                'Precipitation (mm)',
                'Wind direction',
                'Wind speed (m/s)',
                'Name of the air-quality monitoring site'
        )
)

colnames(missing_values) <- c("# of missing values", "Description")

missing_values <-
        missing_values |> select("Description", "# of missing values")

knitr::kable(missing_values, "pipe")
```

As we are interested to determine how PM2.5 levels have changed, we would like to see if there are any micro changes associated with how these levels shift across months and hours.

```{r data summary year}
summary_by <- function(col) {
        air_data_summary <- air_data |>
                group_by( {{ col }} ) |>
                summarise(mean := round(mean(PM2.5, na.rm = TRUE)),
                          min := round(min(PM2.5, na.rm = TRUE)),
                          max := round(max(PM2.5, na.rm = TRUE))
                                  )
        
        air_data_summary_transpose <-
                as.data.frame(t(as.matrix(air_data_summary)), row.names = c('year','mean','min', 'max'))
        
        names(air_data_summary_transpose) <- lapply(air_data_summary_transpose[1, ], as.character)
        air_data_summary_transpose <- air_data_summary_transpose[-1,] 

        air_data_summary_transpose
}

knitr::kable(summary_by(month), "pipe")
```

*Figure 1. Table of Sample mean of PM2.5 by month*

```{r data summary month}
knitr::kable(summary_by(hour), "pipe")
```

*Figure 2. Table of Sample mean of PM2.5 by hour*

As seen by the histogram, there are variations in the PM2.5 levels across the time of the day and the month of the year. It is especially curious that the PM2.5 levels appear to be lower from 0600hrs to 1700hrs (range between 73 - 77 ug/m^3) as we would expect there to more exhaust released by both factories and vehicles. Moreover, the mean levels of PM2.5 level is at the lowest in August and September. These are some possible questions that we can explore in our further analysis.

# Data Wrangling

We are interested to determine how PM2.5 has changed over two time periods - between **March 1 2013 to Feb 28 2015**, and **March 1 2015 to Feb 28 2017**. As such, we will drop all irrelevant columns, and only kept year, month, PM2.5. We have also created a derived column 'class', which will act as our target variable.

```{r spilt data}
air_data_processed <- air_data |>
  select(year, month, PM2.5) |>
  drop_na(PM2.5) |>
  mutate(class = ifelse((year >=2013 & year <=2014) | (year == 2015 & month <=2),
                        'time_A',
                        'time_B'))

air_data_processed
```

# Exploratory analysis on the training data set

We will perform exploratory data analysis steps to highlight the distribution of PM2.5 data points for both time_A and time_B.

## Distribution of data points for each class

```{r counts for each class}
time_A_sum <- sum(air_data_processed$class == 'time_A')
time_B_sum <- sum(air_data_processed$class == 'time_B')

table_distribution_count <- data.frame(Class = c('time_A', 'time_B'),
                                       'Sum of rows' = c(time_A_sum, time_B_sum))

knitr::kable(table_distribution_count, 'pipe')

```

*Figure 3. Table of sum of rows in each class.*

Both classes are equally distributed. As such, we are not concerned about class imbalance which could lead to statistical parity.

## Distribution of PM2.5 levels across time_A and time_B

Having verified that both classes are balanced, we move on to observe the distribution between both time_A and time_B.

```{r EDA boxplot and histogram}
sample_A_B_boxplot <- air_data_processed |>
  group_by(class) |>
  ggplot(aes(x=PM2.5, y=class, fill = class)) +
  geom_boxplot(names=c('time_A', 'time_B'), 
               outlier.alpha = 0.1,
               outlier.fill = NULL) +
  geom_point(stat = 'summary', fun = 'mean', color = 'black') +
  labs(title = 'time_A has a higher median and mean value than time_B',
       subtitle = 'Both time_A and time_B are heavily right skewed') +
  theme(axis.title.y=element_blank(),
        axis.text.y = element_blank(),
        axis.ticks.y = element_blank(),
        axis.title.x=element_blank(),
        axis.text.x = element_blank())

histogram <- air_data_processed |>
  ggplot(aes(x=PM2.5, fill=class)) +
  geom_histogram(bins=30) +
  facet_wrap(~class, ncol = 1) +
  theme(axis.title.y=element_blank(),
        axis.text.y = element_blank(),
        axis.ticks.y = element_blank())


plot_grid(
  plot_grid(ggplot(),
            sample_A_B_boxplot,
            rel_widths = c(1,70)),
  plot_grid(histogram + theme(legend.position = 'none'),
            ggplot(),
            ncol=2,
            rel_widths = c(12,1.75)),
  ncol=1)

```

*Figure 4. Boxplot and Histogram for both samples' PM2.5 distribution. (Black dots represent the mean PM2.5 value of each sample).*

The scale in the x-axis is identical for both plots. Both samples are heavily right skewed, as seen from numerous right-sided outliers in the boxplot and the long right tail in the histograms. time_A has a higher median and mean PM2.5 value than time_B, and its data distribution is wider than B. It is fair to conclude that the median and mean values are too similar to make a definitive statement as to whether the air quality has changed over these two time frames.

As our distribution is heavily skewed to the right, the mean is getting drawn to the right side. As such, we need to use median, as it is not sensitive to extreme values since we are taking the 50th percentile of our data.

To explore further, we are plotting a log density graph to see how the PM2.5 levels are distributed.

```{r density plot}
sample_A_B_distribution <- air_data_processed |>
  group_by(class) |>
  ggplot(aes(x=log(PM2.5), fill = class)) +
  geom_density(alpha = 0.4) +
  theme(axis.title.y=element_blank(),
        axis.text.y = element_blank(),
        axis.ticks.y = element_blank()) +
  geom_vline(xintercept = 4.1, color = 'purple') +
  geom_vline(xintercept = 1.3, color = 'orange') +
  labs(x='PM2.5 level (log(ug/m^3))',
       title = 'time_A has a larger number of extreme values than time_B') 
sample_A_B_distribution
```

*Figure 5. Density Plot for time_A and time_B.*

Looking at these areas:  
**(1) on the left of the orange vertical line**  
**(2)** **the right of the purple vertical line,**

it is clear that the area under the curve for time_A in these two sections are larger than the area under the curve of time_B. This indicates time_A has more extreme values than time_B. The area under the curve of time_B dominates between the orange line and purple vertical line (it completely covered the area of time_A). However, there are overlapping areas. The distinct areas of time_A and time_B in this density plot suggests that time_A could possibly have a higher median than time_B.Â 
